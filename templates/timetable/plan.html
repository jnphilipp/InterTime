{% extends "base.html" %}
{% load timetable_extras %}

{% block title %}{{ block.super }} - Stundenplan{% endblock %}

{% block toggle_login %}{% endblock %}

{% block content %}
<script type="text/javascript">
	function Set() {
		var setObj = {}, val = {};

		this.add = function(str) {
		setObj[str] = val;
		};

		this.contains = function(str) {
			return setObj[str] === val;
		};

		this.remove = function(str) {
			delete setObj[str];
		};

		this.values = function() {
			var values = [];
			for (var i in setObj) {
				if (setObj[i] === val) {
					values.push(i);
				}
			}
			return values;
		};
	}

	var module= {mods:[{},]};
	var selected_events = new Set();
</script>

<p><h1 style="text-align: center;">Semesterplan</h1></p>
<p>
	<h4>select semester:</h4>
	<select id="select_semester">
		<option value="-1">choose one</option>
		{% for semester in semesters %}
			<option value="{{ semester.id }}">{{ semester.name }}</option>
		{% endfor %}
	</select>
    <p><a id="link_timetable" href="{% url 'timetable' %}">display timetable</a></p>
	<hr>
</p>

<p>
	<h4>available moduls:</h4>
	<table id="offering">
		<thead>
			<tr>
				<th></th>
				<th>name</th>
				<th>nummer</th>
				<th>lp</th>
				<th>type</th>
				<th>description</th>
			</tr>
		</thead>
		<tbody id="offer_body">
			{% for semester in semesters %}
				{% for modul in semester|module %}
					<tr class="offer_sem{{ semester.id }} offer" id="{{ modul.number }}">
						<td>
							<input type="checkbox" id="{{ modul.number }}_checkbox" name="modul" value="{{ modul.number }}" class="modul_checkbox">
						</td>
						<td>{{ modul.name }}</td>
						<td>{{ modul.number }}</td>
						<td>{% if modul.lp %}{{ modul.lp }}{% endif %}</td>
						<td>{% if modul.modultype %}{{ modul.modultype }}{% endif %}</td>
						<td>{% if modul.description %}{{ modul.description }}{% endif %}</td>
					</tr>
					{% for event in modul|events:semester %}
						<tr class="modul_{{ modul.number }}_events offer" id="{{ modul.number }}_{{ event.id }}">
							<td></td>
							<td id="{{ event.id }}_namefield" class="event_names"><input type="checkbox" id="{{ modul.number }}_{{ event.id }}_checkbox" class="event_checkbox {{ modul.number }}" name="event" value="{{ event.id }}"> {{ event.name }}</td>
							<td>{{ event.eventtype }}</td>
							<td>{{ event.weekday|convert_weekday }}{% if event.weeknumber %} {{ event.weeknumber }}{% endif %}</td>
							<td colspan="2">{{ event.begin }} - {{ event.end }}</td>
                            <input type="hidden" id="{{ event.id }}_begin" value="{{ event.begin }}" >
                            <input type="hidden" id="{{ event.id }}_end" value="{{ event.end }}" >
                            <input type="hidden" id="{{ event.id }}_day" value="{{ event.weekday }}" >
                            <input type="hidden" id="{{ event.id }}_modulnumber" value="{{ modul.number }}" >
						</tr>
					{% endfor %}
				{% endfor %}
			{% endfor %}
		</tbody>
	</table>
</p>



<script type="text/javascript">
    $(document).ready(function(){
        $('.modul_checkbox').prop('checked',false);
        $('.event_checkbox').prop('checked',false);
    });

	$('#select_semester').change(function() {
		var x = document.getElementById('select_semester');
		for ( i = 0; i < x.options.length; i++) {
			$('.offer_sem' + x[i].value).css('display', 'none');
		}
		if ( $(this).val() != -1 ) {
			$('.offer_sem' + $(this).val()).css('display', 'table-row');
		}
	});

	$('.modul_checkbox').click(function() {
		if ( this.checked ) {
			$('.modul_' + $(this).val() + '_events').css('display', 'table-row');
		}
		else {
			$('.modul_' + $(this).val() + '_events').css('display', 'none');
            
            var elements = document.getElementsByClassName( $(this).val() );
            for (var i=0; i<elements.length; i++) {
               if( elements[i].checked == true){
                selected_events.remove( elements[i].value );
               }
            }
            $('.'+ $(this).val()).prop('checked', false);
            checkoverleap();
		}
        setLink();
	});
	$('.event_checkbox').click(function() {
		if ( this.checked ) {
			selected_events.add($(this).val());
		}
		else {
			selected_events.remove($(this).val());
		}
        checkoverleap();
        setLink();
	});
    function setLink()
    {
        var site  = '{% url 'timetable' %}'
        document.getElementById('link_timetable').href = site + '?events=' + selected_events.values();
    }


    function evt(begin,end,day,id,modul){
        this.begin=begin;
        this.end=end;
        this.day=day;
        this.id=id;
        this.modul=modul;
    }

    function checkoverleap()
    {
        var evts = selected_events.values();
        var events =new Array();
        $('.event_names').css('color','black');
        for(i=0;i<evts.length;i++){
            var begin = document.getElementById(evts[i]+'_begin').value;
            var end = document.getElementById(evts[i]+'_end').value;
            var day = document.getElementById(evts[i]+'_day').value;
            var modul= document.getElementById(evts[i]+'_modulnumber').value;
            var e = new evt(begin,end,day,evts[i],modul);
            events[i]=e;
            $('#'+evts[i]+'_namefield').css('color','green');
            
        }
        for(i=0;i<events.length;i++){
            for(j=i;j<events.length;j++){
                if(i==j){continue;}
                if(events[i].day != events[j].day){continue;}

                if(events[i].begin >= events[j].begin && events[i].begin < events[j].end){
                    $('#'+evts[i]+'_namefield').css('color','red');
                    $('#'+evts[j]+'_namefield').css('color','red');
                } 
            }
        }
    }
</script>
{% endblock %}